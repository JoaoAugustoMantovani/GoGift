<app-nav-bar></app-nav-bar>

<div *ngIf="isLoading" class="loading-indicator text-center py-5" style="margin-top: 15vh;">
  <div class="spinner-border" style="color: var(--orange);" role="status">
    <span class="visually-hidden">Carregando dados...</span>
  </div>
  <p style="color: var(--white); margin-top: 1rem;">Carregando informações do Gift Card...</p>
</div>

<div *ngIf="!isLoading">
  <form class="form" (ngSubmit)="onSubmit()" aria-labelledby="formTitle" role="form">
    <section class="container">
      <div class="formheader">
        <p id="formTitle" class="form-description">Editar Gift Card</p>
        <p class="sr-only">Altere as informações do seu Gift Card aqui</p>
      </div>

      <div *ngIf="hasSales" style="width: 100%; background: rgba(230, 130, 16, 0.2); border: 1px solid var(--orange); color: #fff; padding: 15px; margin-bottom: 3vh; border-radius: 10px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
          </svg>
          <span style="font-size: 0.9rem;"><strong>Atenção:</strong> Título e Valor estão bloqueados pois este produto já possui vendas.</span>
      </div>

      <section class="linha">
        <section class="coluna">
          <label for="titulo">Título do produto:</label>
          <input placeholder="Título Gift Card" type="text" id="titulo" name="titulo" 
                 [(ngModel)]="titulo" required 
                 [disabled]="hasSales"
                 [class.disabled-input]="hasSales"
                 [title]="hasSales ? 'Campo bloqueado devido a vendas existentes' : ''">
        </section>

        <section class="coluna">
          <label for="quantidade">Quantidade Disponível:</label>
          <input type="number" min="0" id="quantidade" name="quantidade" [(ngModel)]="quantidade"
            [readonly]="!gerarCodigo" required>
        </section>
      </section>

      <section class="linha desc">
        <section class="coluna">
          <label for="descricao">Descrição do produto:</label>
          <textarea placeholder="Descreva seu produto" id="descricao" name="descricao" [(ngModel)]="descricao"
            aria-required="true"></textarea>
        </section>

        <section class="coluna price-col">
          <label for="desiredAmount">Valor que você quer receber (R$):</label>
          <input
              type="number"
              id="desiredAmount"
              name="desiredAmount"
              [ngModel]="desiredAmount()"
              (ngModelChange)="onDesiredAmountChange($event)"
              min="0.01" step="0.01"
              placeholder="Ex: 10.00"
              required
              class="form-control amount-input"
              [disabled]="hasSales"
              [class.disabled-input]="hasSales"
              style="width: 60%; margin-top: 10px;"
          >

          <div *ngIf="calculatedSellingPrice() > 0" class="price-preview">
              <p>Preço para o cliente será: <strong>{{ calculatedSellingPrice() | currency:'BRL':'symbol':'1.2-2' }}</strong></p>
              <small>(Inclui taxas e comissão da plataforma)</small>
          </div>
        </section>
      </section>

      <section class="linha">
        <section class="coluna validade">
          <label for="validade">Data de Validade (Opcional):</label>
          <input type="date" id="validade" name="validade" [(ngModel)]="validade" class="date-field">
        </section>

        <section class="coluna switch-container">
          <label for="ativo">Ativo</label>
          <div class="inputCheck" role="switch" [attr.aria-checked]="ativo">
            <label class="switch">
              <input type="checkbox" id="ativo" name="ativo" [(ngModel)]="ativo">
              <span class="slider round">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z" />
                 </svg>
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" aria-hidden="true">
                   <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708" />
                 </svg>
              </span>
            </label>
          </div>
        </section>
      </section>

      <section class="linha categ">
         <section class="coluna categoria-col">
            <label for="category">Categoria:</label>
            <select id="category" class="form-control select-field" [(ngModel)]="categoryId" name="categoryId" style="text-align: center;">
                <option [ngValue]="null">Sem categoria</option>
                <option *ngFor="let category of categories" [value]="category.id">
                    {{ category.name }}
                </option>
            </select>
        </section>
      </section>

      <section class="linha last-row">
        <section class="coluna code-management-col">
           <p id="gerarTexto">Gerar códigos aleatoriamente?</p>
            <div class="inputCheck" role="switch" [attr.aria-checked]="gerarCodigo" aria-labelledby="gerarTexto">
                <label class="switch">
                <input type="checkbox" [checked]="gerarCodigo" (change)="toggleGerarCodigo()"
                    aria-label="Alternar geração automática dos códigos">
                <span class="slider round">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16" aria-hidden="true">
                       <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z" />
                     </svg>
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" aria-hidden="true">
                       <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708" />
                     </svg>
                </span>
                </label>
            </div>
            
             <section class="gerarCodigo" [ngStyle]="{
                  'visibility': gerarCodigo ? 'hidden' : 'visible',
                  'opacity': gerarCodigo ? '0' : '1',
                  'height': gerarCodigo ? '0' : '50vh',
                  'margin-top': gerarCodigo ? '0' : '5vh'
                }">
                <label for="codigosManuais">Códigos (separados por ";"):</label>
                <textarea id="codigosManuais" name="codigosManuais" [(ngModel)]="codigosManuais"
                (input)="atualizarQuantidadePelosCodigos()" aria-describedby="gerarTexto" placeholder="Ex: A1B2;C3D4;..."></textarea>
            </section>
        </section>

        <section class="coluna upload-col">
            <label class="file-label" for="fileInput">
                Alterar Imagem
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-up-fill" viewBox="0 0 16 16" aria-hidden="true">
                  <path d="M8 2a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 6.095 0 7.555 0 9.318 0 11.366 1.708 13 3.781 13h8.906C14.502 13 16 11.57 16 9.773c0-1.636-1.242-2.969-2.834-3.194C12.923 3.999 10.69 2 8 2m2.354 5.146a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0z" />
                </svg>
            </label>
            <input type="file" id="fileInput" class="file-upload" (change)="onFileSelected($event)" accept="image/*">

             <div class="imagePreviewer" *ngIf="imageSrc && !showCropper" role="region" aria-label="Pré-visualização da imagem">
                <p>Imagem do Produto:</p>
                <img [src]="imageSrc" alt="Pré-visualização da imagem atual" (error)="imageSrc = null">
            </div>
             
             <div class="imagePreviewer placeholder" *ngIf="!imageSrc && !showCropper">
                 <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" class="bi bi-image" viewBox="0 0 16 16">
                     <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                     <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/>
                 </svg>
                 <p>Sem imagem</p>
            </div>

            <div class="cropper-container" *ngIf="showCropper">
                 <p>Recorte a nova imagem (740x740):</p>
                <image-cropper
                    [imageChangedEvent]="imageChangedEvent"
                    [maintainAspectRatio]="true"
                    [aspectRatio]="1 / 1"
                    [resizeToWidth]="740"
                    format="jpeg"
                    (imageCropped)="imageCropped($event)"
                    (loadImageFailed)="loadImageFailed()">
                </image-cropper>
                 
                 <div class="cropper-actions">
                     <button type="button" (click)="cancelCrop()" class="btn btn-secondary">Cancelar</button>
                     <button type="button" (click)="confirmCrop()" class="btn btn-primary">Confirmar Corte</button>
                 </div>
            </div>
        </section>
      </section>

      <button type="submit" aria-label="Salvar alterações do gift-card" [disabled]="isUploading">
         <span *ngIf="isUploading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
         <span *ngIf="isUploading"> Salvando...</span>
         <span *ngIf="!isUploading">Salvar Alterações</span>
      </button>
    </section>
  </form>

  <app-footer></app-footer>
</div>